<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>H√≥a ƒë∆°n thanh to√°n</title>
  <link rel="stylesheet" href="thanhtoan.css">
</head>

<script>
  function formatDateTime(date) {
    const options = {
      day: '2-digit', month: '2-digit', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit'
    };
    return date.toLocaleString('vi-VN', options);
  }

  document.addEventListener("DOMContentLoaded", function () {
    const now = new Date();
    document.getElementById("invoice-date").textContent = "üïí Ng√†y gi·ªù: " + formatDateTime(now);
  });
</script>

<body>
  <div class="invoice-container" id="invoice">
    <h1>üßæ H√≥a ƒë∆°n mua h√†ng</h1>
    <p class="invoice-date" id="invoice-date"></p>

    <!-- C·∫£m ∆°n -->
    <div class="thankyou-box">
      üéâ C·∫£m ∆°n b·∫°n ƒë√£ mua h√†ng t·∫°i shop! H·∫πn g·∫∑p l·∫°i b·∫°n l·∫ßn sau!
    </div>

    <table class="invoice-table">
      <thead>
        <tr>
          <th>S·∫£n ph·∫©m</th>
          <th>M√£</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi√° g·ªëc</th>
          <th>Gi√° gi·∫£m</th>
          <th>Th√†nh ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="invoice-items"></tbody>
    </table>

    <p class="total-amount">T·ªïng c·ªông: <span id="invoice-total">0ƒë</span></p>

    <div class="info-note">
      üì∏ Vui l√≤ng ch·ª•p m√†n h√¨nh ƒë∆°n h√†ng v√† nh·∫Øn tin cho ch√∫ng t√¥i qua Zalo
    </div>

    <div class="button-container">
      <a href="https://zalo.me/0902850736" target="_blank" class="zalo-button">üí¨ Nh·∫Øn Zalo</a>
      <button onclick="downloadInvoice()" class="download-button">üì• T·∫£i h√≥a ƒë∆°n</button>
    </div>
  </div>

  <script>
    const cart = JSON.parse(localStorage.getItem("cart")) || [];

    function renderInvoice() {
      const itemsContainer = document.getElementById("invoice-items");
      const totalDisplay = document.getElementById("invoice-total");

      const grouped = {};
      let total = 0;

      cart.forEach(item => {
        const key = item.code;
        if (!grouped[key]) {
          grouped[key] = { ...item, quantity: 1 };
        } else {
          grouped[key].quantity += 1;
        }
      });

      itemsContainer.innerHTML = "";
      Object.values(grouped).forEach(item => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.code}</td>
          <td>${item.quantity}</td>
          <td>${(item.originalPrice || item.price).toLocaleString("vi-VN")}ƒë</td>
          <td>${item.price.toLocaleString("vi-VN")}ƒë</td>
          <td>${itemTotal.toLocaleString("vi-VN")}ƒë</td>
        `;
        itemsContainer.appendChild(row);
      });

      totalDisplay.textContent = total.toLocaleString("vi-VN") + "ƒë";
    }

    function downloadInvoice() {
      const invoice = document.getElementById("invoice");
      const opt = {
        margin: 0.5,
        filename: "hoa-don.pdf",
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(invoice).save();
    }

    renderInvoice();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</body>
</html>
